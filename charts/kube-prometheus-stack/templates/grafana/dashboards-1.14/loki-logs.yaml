{{- /* Added manually, can be changed in-place. */ -}}
{{- $kubeTargetVersion := default .Capabilities.KubeVersion.GitVersion .Values.kubeTargetVersionOverride }}
{{- if and (or .Values.grafana.enabled .Values.grafana.forceDeployDashboards) (semverCompare ">=1.14.0-0" $kubeTargetVersion) (semverCompare "<9.9.9-9" $kubeTargetVersion) .Values.grafana.defaultDashboardsEnabled .Values.coreDns.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: {{ template "kube-prometheus-stack-grafana.namespace" . }}
  name: {{ printf "%s-%s" (include "kube-prometheus-stack.fullname" $) "loki-logs" | trunc 63 | trimSuffix "-" }}
  annotations:
{{ toYaml .Values.grafana.sidecar.dashboards.annotations | indent 4 }}
  labels:
    {{- if $.Values.grafana.sidecar.dashboards.label }}
    {{ $.Values.grafana.sidecar.dashboards.label }}: {{ ternary $.Values.grafana.sidecar.dashboards.labelValue "1" (not (empty $.Values.grafana.sidecar.dashboards.labelValue)) | quote }}
    {{- end }}
    app: {{ template "kube-prometheus-stack.name" $ }}-grafana
{{ include "kube-prometheus-stack.labels" $ | indent 4 }}
data:
  loki-logs.json: |-
      {
        "annotations": {
          "list": [
            {
              "$$hashKey": "object:75",
              "builtIn": 1,
              "datasource": {
                "type": "datasource",
                "uid": "grafana"
              },
              "enable": true,
              "hide": true,
              "iconColor": "rgba(0, 211, 255, 1)",
              "name": "Annotations & Alerts",
              "type": "dashboard"
            }
          ]
        },
        "description": "Log Viewer Dashboard for Loki",
        "editable": true,
        "fiscalYearStartMonth": 0,
        "gnetId": 13639,
        "graphTooltip": 0,
        "id": 89,
        "links": [
          {
            "$$hashKey": "object:59",
            "icon": "bolt",
            "includeVars": true,
            "keepTime": true,
            "tags": [],
            "targetBlank": true,
            "title": "View In Explore",
            "type": "link",
            "url": "/explore?orgId=1&left=[\"now-1h\",\"now\",\"Loki\",{\"expr\":\"{job=\\\"$app\\\"}\"},{\"ui\":[true,true,true,\"none\"]}]"
          },
          {
            "$$hashKey": "object:61",
            "icon": "external link",
            "tags": [],
            "targetBlank": true,
            "title": "Learn LogQL",
            "type": "link",
            "url": "https://grafana.com/docs/loki/latest/logql/"
          }
        ],
        "liveNow": false,
        "panels": [
          {
            "aliasColors": {},
            "bars": true,
            "dashLength": 10,
            "dashes": false,
            "datasource": {
              "type": "loki",
              "uid": "$datasource"
            },
            "fieldConfig": {
              "defaults": {
                "links": []
              },
              "overrides": []
            },
            "fill": 1,
            "fillGradient": 0,
            "gridPos": {
              "h": 3,
              "w": 24,
              "x": 0,
              "y": 0
            },
            "hiddenSeries": false,
            "id": 6,
            "legend": {
              "avg": false,
              "current": false,
              "max": false,
              "min": false,
              "show": false,
              "total": false,
              "values": false
            },
            "lines": false,
            "linewidth": 1,
            "nullPointMode": "null",
            "options": {
              "alertThreshold": true
            },
            "percentage": false,
            "pluginVersion": "10.0.3",
            "pointradius": 2,
            "points": false,
            "renderer": "flot",
            "seriesOverrides": [],
            "spaceLength": 10,
            "stack": false,
            "steppedLine": false,
            "targets": [
              {
                "datasource": {
                  "uid": "$datasource"
                },
                "editorMode": "code",
                "expr": "sum(count_over_time({namespace=\"$namespace\", app=\"$app\"} |= \"$search\" [$__interval]))",
                "legendFormat": "",
                "queryType": "range",
                "refId": "A"
              }
            ],
            "thresholds": [],
            "timeRegions": [],
            "tooltip": {
              "shared": true,
              "sort": 0,
              "value_type": "individual"
            },
            "type": "graph",
            "xaxis": {
              "mode": "time",
              "show": true,
              "values": []
            },
            "yaxes": [
              {
                "$$hashKey": "object:168",
                "format": "short",
                "logBase": 1,
                "show": false
              },
              {
                "$$hashKey": "object:169",
                "format": "short",
                "logBase": 1,
                "show": false
              }
            ],
            "yaxis": {
              "align": false
            }
          },
          {
            "datasource": {
              "type": "loki",
              "uid": "${datasource}"
            },
            "gridPos": {
              "h": 25,
              "w": 24,
              "x": 0,
              "y": 3
            },
            "id": 2,
            "maxDataPoints": "",
            "options": {
              "dedupStrategy": "none",
              "enableLogDetails": true,
              "prettifyLogMessage": false,
              "showCommonLabels": false,
              "showLabels": false,
              "showTime": true,
              "sortOrder": "Descending",
              "wrapLogMessage": false
            },
            "targets": [
              {
                "datasource": {
                  "uid": "${datasource}"
                },
                "editorMode": "builder",
                "expr": "{namespace=\"$namespace\", app=\"$app\"} |= `$search` | json",
                "hide": false,
                "legendFormat": "",
                "queryType": "range",
                "refId": "A"
              }
            ],
            "transparent": true,
            "type": "logs"
          }
        ],
        "refresh": "",
        "schemaVersion": 38,
        "style": "dark",
        "tags": [],
        "templating": {
          "list": [
            {
              "current": {
                "selected": false,
                "text": "Loki-K8s-Production",
                "value": "Loki-K8s-Production"
              },
              "hide": 0,
              "includeAll": false,
              "label": "Datasource",
              "multi": false,
              "name": "datasource",
              "options": [],
              "query": "loki",
              "queryValue": "",
              "refresh": 1,
              "regex": "",
              "skipUrlSync": false,
              "type": "datasource"
            },
            {
              "current": {
                "selected": true,
                "text": "portal-services",
                "value": "portal-services"
              },
              "datasource": {
                "type": "loki",
                "uid": "P8E286AE64D1A2D70"
              },
              "definition": "",
              "hide": 0,
              "includeAll": false,
              "label": "Namespace",
              "multi": false,
              "name": "namespace",
              "options": [],
              "query": {
                "label": "namespace",
                "refId": "LokiVariableQueryEditor-VariableQuery",
                "stream": "",
                "type": 1
              },
              "refresh": 1,
              "regex": "",
              "skipUrlSync": false,
              "sort": 5,
              "type": "query"
            },
            {
              "current": {
                "selected": true,
                "text": "blu-cli",
                "value": "blu-cli"
              },
              "datasource": {
                "uid": "${datasource}"
              },
              "definition": "",
              "hide": 0,
              "includeAll": false,
              "label": "App",
              "multi": false,
              "name": "app",
              "options": [],
              "query": {
                "label": "job",
                "refId": "LokiVariableQueryEditor-VariableQuery",
                "stream": "",
                "type": 1
              },
              "refresh": 1,
              "regex": "/$namespace\\/(.*)/",
              "skipUrlSync": false,
              "sort": 0,
              "tagValuesQuery": "",
              "tagsQuery": "",
              "type": "query",
              "useTags": false
            },
            {
              "hide": 0,
              "label": "String Match",
              "name": "search",
              "options": [],
              "query": "404",
              "skipUrlSync": false,
              "type": "textbox"
            }
          ]
        },
        "time": {
          "from": "now-5m",
          "to": "now"
        },
        "timepicker": {
          "hidden": false,
          "refresh_intervals": [
            "10s",
            "30s",
            "1m",
            "5m",
            "15m",
            "30m",
            "1h",
            "2h",
            "1d"
          ]
        },
        "timezone": "",
        "title": "Logs / App",
        "uid": "blu-cloud-team-dashboards",
        "version": 1,
        "weekStart": ""
      }
{{- end }}
